<!-- File: index.html (Frontend) -->
<!doctype html>
<html lang="en">
<head>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Lazy Day Mobile Oil â€“ Book Now</title>
<style>
:root{--ink:#0f172a;--brand:#0E2A47;--ring:#e5e7eb;--bg:#F7F1E6;--accent:#C7382E}
*{box-sizing:border-box}html{scroll-behavior:smooth}
body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.5 Inter,system-ui,Arial}
.wrap{max-width:1100px;margin:0 auto;padding:20px}
.h1{font-size:28px;font-weight:900;color:var(--brand);margin:0 0 8px}
.card{background:#fff;border:1px solid var(--ring);border-radius:16px;padding:18px;margin:12px 0;box-shadow:0 4px 12px rgba(0,0,0,.04)}
.row{display:grid;gap:12px}
@media(min-width:900px){.two{grid-template-columns:1fr 1fr}.three{grid-template-columns:1fr 1fr 1fr}.four{grid-template-columns:repeat(4,1fr)}}
label{font-size:13px;font-weight:600;display:block;margin-bottom:4px}
input,select,textarea{width:100%;padding:10px;border:1px solid var(--ring);border-radius:10px}
.btn{background:var(--accent);color:#fff;border:none;border-radius:10px;padding:10px 14px;font-weight:800;cursor:pointer}
.btn[disabled]{opacity:.45;cursor:not-allowed}
.note{font-size:12px;color:#6b7280}
.preview-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
.preview-grid img{width:100%;height:90px;object-fit:cover;border-radius:8px;border:1px solid var(--ring)}
.table{width:100%;border-collapse:collapse}
.table td{padding:6px 0;border-bottom:1px dotted #d1d5db}
.table td:last-child{text-align:right}
.total-line{font-weight:900}
.badge{display:inline-block;background:#e2e8f0;color:#111;border-radius:999px;padding:2px 8px;font-size:12px}
.tile-group{display:grid;gap:12px}
@media(min-width:900px){.tile-group.four{grid-template-columns:repeat(4,1fr)}.tile-group.two{grid-template-columns:repeat(2,1fr)}}
.tile{border:2px solid var(--ring);border-radius:14px;padding:12px;display:flex;justify-content:space-between;align-items:center;background:#fff}
.tile input{transform:scale(1.3);margin-right:10px}
.tile strong{font-size:15px}
.tile small{color:#475569}
.addons-head{font-size:16px;font-weight:800;margin:6px 0}
.boxed{border:2px solid var(--ring);border-radius:14px;padding:12px}
</style>
</head>
<body>

<div class="wrap">
  <div class="h1">Lazy Day Mobile Oil <span class="badge">Hours: 9:30 AM â€“ 7:30 PM</span></div>
  <p class="note">Serving Greenwood, IN & nearby. VIN lookup auto-fills vehicle specs. Card payment handled via Stripe Checkout.</p>

  <!-- CONTACT -->
  <section class="card"><h2>Contact</h2>
    <div class="row two">
      <div><label>First Name</label><input id="firstName" autocomplete="given-name"></div>
      <div><label>Last Name</label><input id="lastName" autocomplete="family-name"></div>
      <div><label>Phone</label><input id="phone" inputmode="tel" placeholder="(###) ###-####"></div>
      <div><label>Email</label><input id="email" inputmode="email" placeholder="you@email.com"></div>
    </div>
  </section>

  <!-- PHOTOS -->
  <section class="card"><h2>Vehicle Photos</h2>
    <div class="row four">
      <div><label>Front</label><input type="file" id="photoFront" accept="image/*"></div>
      <div><label>Driver Side</label><input type="file" id="photoDriver" accept="image/*"></div>
      <div><label>Passenger Side</label><input type="file" id="photoPassenger" accept="image/*"></div>
      <div><label>Rear</label><input type="file" id="photoRear" accept="image/*"></div>
    </div>
    <div id="photoPreview" class="preview-grid" style="margin-top:8px"></div>
  </section>

  <!-- ADDRESS -->
  <section class="card"><h2>Service Address & Technician Notes</h2>
    <div class="row two">
      <div><label>Address</label><input id="addr"></div>
      <div><label>City</label><input id="city"></div>
      <div><label>State</label><input id="state" value="IN"></div>
      <div><label>ZIP</label><input id="zip" inputmode="numeric"></div>
    </div>
    <label>Technician Notes</label>
    <textarea id="techNotes" rows="3" placeholder="Parked in driveway, gate code 1234â€¦"></textarea>
  </section>

  <!-- VIN -->
  <section class="card"><h2>VIN Lookup</h2>
    <div class="row two">
      <div><label>VIN</label><input id="vin" maxlength="17" placeholder="1HGCM82633A004352"></div>
      <div style="align-self:end"><button class="btn" id="vinLookupBtn" type="button">Lookup VIN</button>
    </div>
    <div id="decodeStatus" class="note"></div>
    <div class="row three">
      <div><label>Year</label><input id="year" readonly></div>
      <div><label>Make</label><input id="make" readonly></div>
      <div><label>Model</label><input id="model" readonly></div>
    </div>
    <div class="row three">
      <div><label>Engine</label><input id="engine" readonly></div>
      <div><label>Oil Capacity (qts)</label><input id="capacity" type="number" step="0.1" placeholder="5.5"><div class="note" id="capHelp"></div></div>
      <div><label>Oil Grade</label>
        <select id="viscosity">
          <option value="">Selectâ€¦</option>
          <option>0W-16</option><option>0W-20</option><option>5W-20</option>
          <option>5W-30</option><option>0W-30</option><option>10W-30</option><option>5W-40</option>
        </select>
        <div class="note" id="viscHelp"></div>
      </div>
    </div>
  </section>

  <!-- SERVICES -->
  <section class="card"><h2>Services</h2>
    <div class="row two">
      <div><label>Primary Service</label>
        <select id="service">
          <option value="" disabled selected hidden>Select a serviceâ€¦</option>
          <option value="oil">Oil Change (includes 5 qts)</option>
          <option value="brakes_front">Front Brake Pads (Bundle)</option>
          <option value="brakes_rear">Rear Brake Pads (Bundle)</option>
          <option value="brakes_both">Front & Rear Brake Pads (Bundle)</option>
          <option value="oil_both">Oil + F&R Brake Pads (Bundle)</option>
        </select>
        <div id="serviceHelp" class="note" style="margin-top:6px"></div>
      </div>
      <div><label>Oil Type</label>
        <select id="oilType"><option value="conv">Conventional</option><option value="syn">Full Synthetic (+)</option></select>
      </div>
    </div>

    <div class="boxed" style="margin-top:8px">
      <div class="addons-head">Brake Parts (optional)</div>
      <div class="tile-group four">
        <label class="tile"><span><input type="checkbox" id="rotF"> <strong>Rotors (Front, pair)</strong></span> <small id="hintRotF"></small></label>
        <label class="tile"><span><input type="checkbox" id="rotR"> <strong>Rotors (Rear, pair)</strong></span> <small id="hintRotR"></small></label>
        <label class="tile"><span><input type="checkbox" id="calF"> <strong>Calipers (Front, pair)</strong></span> <small id="hintCalF"></small></label>
        <label class="tile"><span><input type="checkbox" id="calR"> <strong>Calipers (Rear, pair)</strong></span> <small id="hintCalR"></small></label>
        <label class="tile" style="grid-column:1/-1"><span><input type="checkbox" id="calB"> <strong>Calipers (Front & Rear)</strong></span> <small id="hintCalB"></small></label>
      </div>
    </div>

    <div class="boxed" style="margin-top:12px">
      <div class="addons-head">Add-ons</div>
      <div id="addons" class="tile-group two"></div>
    </div>
  </section>

  <!-- DATE/TIME -->
  <section class="card"><h2>Preferred Date & Time</h2>
    <div class="row two">
      <div><label>Date</label><input id="prefDate" type="date"></div>
      <div><label>Time</label><select id="prefSlot"><option value="" disabled selected hidden>Select a timeâ€¦</option></select></div>
    </div>
    <div id="calHelp" class="note" style="margin-top:6px"></div>
    <button class="btn" id="findTimes" style="margin-top:8px">Check Availability</button>
  </section>

  <!-- CART -->
  <section class="card"><h2>Your Cart</h2>
    <table class="table"><tbody id="lines"><tr><td class="note">No items yet</td><td class="note">$0.00</td></tr></tbody>
      <tbody>
        <tr id="discountRow" style="display:none"><td>Discount (<span id="promoName"></span>)</td><td id="discount">-$0.00</td></tr>
        <tr><td>Indiana Sales Tax (7%)</td><td id="tax">$0.00</td></tr>
        <tr class="total-line"><td>Total</td><td id="total">$0.00</td></tr>
      </tbody>
    </table>
    <div class="row two" style="margin-top:6px">
      <div><label>Promo code</label><input id="promoInput" placeholder="Promo Code here"></div>
      <div style="align-self:end"><button class="btn" id="applyPromo" type="button">Apply</button> <span class="note" id="promoMsg"></span></div>
    </div>
    <div style="display:flex;gap:8px;align-items:center;justify-content:flex-end;margin-top:10px">
      <button class="btn" id="cashOut" disabled>Pay & Book</button>
      <span id="submitNote" class="note"></span>
    </div>
  </section>
</div>
<script>
/*** ===============================
 *  CONFIG
 * =============================== */

// ðŸ”— Your deployed Apps Script Web App URL (ENDS WITH /exec)
const GAS_ENDPOINT = "https://script.google.com/macros/s/AKfycbzo6QgEqlVlEy6Ht8mRIDHxL2p5TeSkbbfif_VEmRgka80E2_gRokVUNrNMbHZJ9WZW/exec";

// Business + pricing
const BIZ_NAME = "Lazy Day Mobile Oil";
const TAX_RATE = 0.07;            // 7% Indiana sales tax
const PRICING = {
  oilBase: 109.99,                // base oil change price (incl. up to 5 qts)
  extraQt: 7.99,                  // per extra quart
  synUp: 29.99                    // upgrade to full synthetic, if you use it
};

// Acuity appointment type IDs (must match what you set in Acuity)
const ACUITY_TYPES = {
  oil: 85384590,
  brakes_front: 85384591,
  brakes_rear: 85384592,
  brakes_both: 85384593,
  oil_brakes: 85384594
};

// Helper
const byId = (id) => document.getElementById(id);

/*** ===============================
 *  UI HELPERS
 * =============================== */

// Format money
function fmtMoney(n) {
  return "$" + (n || 0).toFixed(2);
}

// Read number from input (or 0)
function numVal(id) {
  const el = byId(id);
  if (!el) return 0;
  const v = parseFloat(el.value);
  return isNaN(v) ? 0 : v;
}

// Show note / error under the Pay & Book button
function setSubmitNote(msg, isError = false) {
  const el = byId("submitNote");
  if (!el) return;
  el.textContent = msg || "";
  el.style.color = isError ? "#b91c1c" : "#065f46";
}

// Optional little note under Date/Time (if you add <small id="availNote">)
function setAvailNote(msg) {
  const el = byId("availNote");
  if (!el) return;
  el.textContent = msg || "";
}

/*** ===============================
 *  CART / TOTALS
 * =============================== */

function computeTotals() {
  // Read current capacity
  const qts = numVal("capacity"); // total qt capacity (0 if empty / invalid)

  let subtotal = 0;
  let extraQts = 0;

  // Only charge for oil if we have a capacity number
  if (qts > 0) {
    subtotal += PRICING.oilBase;               // base service
    extraQts = Math.max(0, qts - 5);           // anything over 5 qts
    subtotal += extraQts * PRICING.extraQt;
  }

  // TODO: add-ons & brakes can be added here later, e.g.:
  // if (byId("rotorsFront")?.checked) subtotal += 199.99;

  // Tax only on whatever subtotal we have
  const tax = subtotal * TAX_RATE;
  const total = subtotal + tax;

  // Update DOM
  const subtotalEl = byId("subtotal");
  const taxEl = byId("tax");
  const totalEl = byId("total");
  if (subtotalEl) subtotalEl.textContent = fmtMoney(subtotal);
  if (taxEl) taxEl.textContent = fmtMoney(tax);
  if (totalEl) totalEl.textContent = fmtMoney(total);

  return { subtotal, tax, total, extraQts };
}

function updateCheckoutState() {
  const { total } = computeTotals();
  const needed = missing();
  const btn = byId("cashOut");
  if (!btn) return;
  btn.disabled = !!needed.length || total <= 0;
}

/*** ===============================
 *  FIELD VALIDATION
 * =============================== */

function missing() {
  const fields = [
    { id: "firstName", label: "First name" },
    { id: "lastName", label: "Last name" },
    { id: "phone", label: "Phone" },
    { id: "email", label: "Email" },
    { id: "vin", label: "VIN" },
    { id: "prefDate", label: "Preferred date" },
    { id: "prefSlot", label: "Preferred time" },
    { id: "addr", label: "Service address" },
    { id: "city", label: "City" },
    { id: "state", label: "State" },
    { id: "zip", label: "ZIP" }
  ];

  const missing = [];
  fields.forEach(f => {
    const el = byId(f.id);
    if (!el) return;
    const v = (el.value || "").trim();
    if (!v) missing.push(f.label);
  });
  return missing;
}

/*** ===============================
 *  VIN LOOKUP (NHTSA)
 * =============================== */

async function handleVinLookup() {
  const vinEl = byId("vin");
  if (!vinEl) {
    console.error("VIN input #vin not found");
    return;
  }

  const rawVin = (vinEl.value || "").trim();
  if (!rawVin) {
    alert("Please enter a VIN first.");
    return;
  }

  const vin = rawVin.replace(/[^0-9A-Za-z]/g, "").toUpperCase();
  if (vin.length < 11) {
    alert("Please enter a valid VIN (at least 11 characters).");
    return;
  }

  const yearEl   = byId("year");
  const makeEl   = byId("make");
  const modelEl  = byId("model");
  const engineEl = byId("engine");

  if (yearEl)   yearEl.value   = "";
  if (makeEl)   makeEl.value   = "";
  if (modelEl)  modelEl.value  = "";
  if (engineEl) engineEl.value = "";

  try {
    const url = `https://vpic.nhtsa.dot.gov/api/vehicles/decodevinvaluesextended/${encodeURIComponent(vin)}?format=json`;
    const res = await fetch(url);
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();

    if (!data || !Array.isArray(data.Results) || !data.Results.length) {
      alert("No vehicle data returned for that VIN.");
      return;
    }

    const r = data.Results[0];

    if (yearEl)   yearEl.value   = r.ModelYear || "";
    if (makeEl)   makeEl.value   = r.Make || "";
    if (modelEl)  modelEl.value  = r.Model || "";

    if (engineEl) {
      const sizeL = r.DisplacementL || r.EngineDisplacementL || "";
      const cyl   = r.EngineCylinders || "";
      const cfg   = r.EngineConfiguration || "";
      const descr = [sizeL ? `${sizeL}L` : "", cyl ? `${cyl} cyl` : "", cfg]
        .filter(Boolean)
        .join(" ");
      engineEl.value = descr;
    }

    // NHTSA does *not* give oil capacity; you can still type capacity manually.
    updateCheckoutState();
  } catch (err) {
    console.error("VIN lookup error", err);
    alert("Could not look up VIN right now. Please try again or enter details manually.");
  }
}

/*** ===============================
 *  ACUITY â€“ LOAD TIMES
 * =============================== */

async function loadTimesForDate() {
  const dateEl = byId("prefDate");
  const slotEl = byId("prefSlot");
  if (!dateEl || !slotEl) return;

  const date = dateEl.value; // "YYYY-MM-DD"
  if (!date) return;

  const serviceSel = byId("service");
  const serviceKey = serviceSel ? serviceSel.value : "oil";
  const appointmentTypeID = ACUITY_TYPES[serviceKey] || ACUITY_TYPES.oil;

  // Reset dropdown
  slotEl.innerHTML = "";
  const opt = document.createElement("option");
  opt.textContent = "Loading times...";
  opt.value = "";
  slotEl.appendChild(opt);
  slotEl.disabled = true;
  setAvailNote("Checking Acuity scheduleâ€¦");

  try {
    const url = `${GAS_ENDPOINT}?path=times` +
      `&appointmentTypeID=${encodeURIComponent(appointmentTypeID)}` +
      `&date=${encodeURIComponent(date)}`;

    const res = await fetch(url);
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const json = await res.json();

    slotEl.innerHTML = "";
    if (!json.ok || !Array.isArray(json.slots) || !json.slots.length) {
      const o = document.createElement("option");
      o.textContent = json.error || "No times available";
      o.value = "";
      slotEl.appendChild(o);
      slotEl.disabled = true;
      setAvailNote(json.error || "No open times for that day.");
      return;
    }

    json.slots.forEach(s => {
      const o = document.createElement("option");
      o.value = s.time;
      o.textContent = s.time;
      slotEl.appendChild(o);
    });

    slotEl.disabled = false;
    setAvailNote("");
  } catch (err) {
    console.error("loadTimesForDate error", err);
    slotEl.innerHTML = "";
    const o = document.createElement("option");
    o.textContent = "Acuity error 403";
    o.value = "";
    slotEl.appendChild(o);
    slotEl.disabled = true;
    setAvailNote("Acuity error â€“ check API keys.");
  }
}

/*** ===============================
 *  STRIPE CHECKOUT FLOW (via GAS)
 * =============================== */

async function handlePayAndBook() {
  const need = missing();
  if (need.length) {
    setSubmitNote("Missing: " + need.join(", "), true);
    updateCheckoutState();
    return;
  }

  const { total, extraQts } = computeTotals();
  const amountCents = Math.round(total * 100);

  const serviceSel = byId("service");
  const serviceKey = serviceSel ? serviceSel.value : "oil";
  const appointmentTypeID = ACUITY_TYPES[serviceKey] || ACUITY_TYPES.oil;

  const d = byId("prefDate")?.value || "";
  const t = byId("prefSlot")?.value || "";
  const datetime = d && t ? `${d} ${t}` : "";

  const payload = {
    amountCents,
    appointmentTypeID,
    datetime,
    firstName: byId("firstName")?.value || "",
    lastName: byId("lastName")?.value || "",
    email: byId("email")?.value || "",
    phone: byId("phone")?.value || "",
    notes: [
      `VIN: ${(byId("vin")?.value || "").toUpperCase()}`,
      `Capacity: ${byId("capacity")?.value || ""} qts (extra: ${extraQts})`,
      `Oil Grade: ${byId("viscosity")?.value || ""}`,
      `Addr: ${byId("addr")?.value || ""}, ${byId("city")?.value || ""}, ${byId("state")?.value || ""} ${byId("zip")?.value || ""}`,
      `Tech notes: ${byId("techNotes")?.value || ""}`
    ].join(" | ")
  };

  const btn = byId("cashOut");
  if (btn) btn.disabled = true;
  setSubmitNote("Creating secure checkout with Stripeâ€¦", false);

  try {
    const res = await fetch(`${GAS_ENDPOINT}?path=stripe_create`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });
    const json = await res.json();

    if (!json.ok || !json.url) {
      console.error(json);
      setSubmitNote(json.error || "Unable to start checkout. Please call or text to book.", true);
      if (btn) btn.disabled = false;
      return;
    }

    window.location.href = json.url;   // Stripe Checkout
  } catch (err) {
    console.error(err);
    setSubmitNote("Network error talking to server. Please try again.", true);
    if (btn) btn.disabled = false;
  }
}

/*** ===============================
 *  INIT â€“ WIRE UP EVENTS
 * =============================== */

function initLDMO() {
  const inputsToWatch = [
    "capacity", "firstName", "lastName", "phone", "email",
    "vin", "prefDate", "prefSlot", "addr", "city", "state", "zip"
  ];
  inputsToWatch.forEach(id => {
    const el = byId(id);
    if (!el) return;
    el.addEventListener("input", updateCheckoutState);
    el.addEventListener("change", updateCheckoutState);
  });

  const prefDateEl = byId("prefDate");
  if (prefDateEl) {
    prefDateEl.addEventListener("change", () => {
      loadTimesForDate();
      updateCheckoutState();
    });
  }

  const cashBtn = byId("cashOut");
  if (cashBtn) {
    cashBtn.addEventListener("click", (e) => {
      e.preventDefault();
      handlePayAndBook();
    });
  }

  const vinBtn = byId("vinLookupBtn");  // your VIN button must have id="vinLookupBtn"
  if (vinBtn) {
    vinBtn.addEventListener("click", (e) => {
      e.preventDefault();
      handleVinLookup();
    });
  }

  // Initial totals
  computeTotals();
  updateCheckoutState();
}

document.addEventListener("DOMContentLoaded", initLDMO);
</script>
</body>
</html>








