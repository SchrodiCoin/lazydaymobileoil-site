<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Lazy Day Mobile Oil – Book Service</title>
  <style>
    :root{
      --ink:#0f172a;
      --brand:#0E2A47;
      --accent:#C7382E;
      --bg:#F7F1E6;
      --ring:#e5e7eb;
      --muted:#6b7280;
      --radius-lg:18px;
    }
    *{box-sizing:border-box}
    html{scroll-behavior:smooth}
    body{
      margin:0;
      background:var(--bg);
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      color:var(--ink);
    }
    .wrap{
      max-width:1100px;
      margin:0 auto;
      padding:20px 16px 60px;
    }
    .h1{
      margin:0 0 4px;
      font-size:30px;
      font-weight:900;
      color:var(--brand);
      letter-spacing:.02em;
    }
    .sub{
      margin:0 0 18px;
      color:var(--muted);
      font-size:14px;
    }
    .grid{display:grid;gap:12px}
    @media(min-width:768px){
      .grid-2{grid-template-columns:repeat(2,minmax(0,1fr))}
      .grid-3{grid-template-columns:repeat(3,minmax(0,1fr))}
      .grid-4{grid-template-columns:repeat(4,minmax(0,1fr))}
    }
    .card{
      background:#fff;
      border-radius:var(--radius-lg);
      border:1px solid var(--ring);
      padding:16px 16px 18px;
      box-shadow:0 18px 30px rgba(15,23,42,.06);
      margin-bottom:16px;
    }
    .card-header{
      display:flex;
      justify-content:space-between;
      align-items:flex-end;
      margin-bottom:10px;
      gap:8px;
    }
    .card-title{
      font-size:18px;
      font-weight:700;
      color:var(--brand);
      margin:0;
    }
    .label{
      font-size:12px;
      font-weight:600;
      text-transform:uppercase;
      letter-spacing:.06em;
      color:var(--muted);
      margin-bottom:4px;
    }
    .input, select, textarea{
      width:100%;
      padding:8px 10px;
      border-radius:10px;
      border:1px solid var(--ring);
      font-size:14px;
      outline:0;
      background:#f9fafb;
      transition:border-color .15s, box-shadow .15s, background .15s;
      font-family:inherit;
      resize:vertical;
    }
    .input:focus, select:focus, textarea:focus{
      background:#fff;
      border-color:var(--brand);
      box-shadow:0 0 0 1px rgba(15,23,42,.15);
    }
    .btn{
      border-radius:999px;
      padding:9px 16px;
      border:0;
      font-size:14px;
      font-weight:600;
      cursor:pointer;
      background:var(--brand);
      color:#fff;
      display:inline-flex;
      align-items:center;
      gap:6px;
      box-shadow:0 10px 20px rgba(15,23,42,.18);
      transition:transform .12s, box-shadow .12s, background .12s;
      white-space:nowrap;
    }
    .btn:hover{
      transform:translateY(-1px);
      box-shadow:0 16px 30px rgba(15,23,42,.22);
      background:#102b4f;
    }
    .btn:disabled{
      opacity:.6;
      cursor:default;
      transform:none;
      box-shadow:none;
    }
    .btn-outline{
      background:#fff;
      color:var(--brand);
      border:1px solid var(--ring);
      box-shadow:none;
    }
    .btn-outline:hover{
      background:#f3f4f6;
      box-shadow:none;
      transform:none;
    }
    .pill-check{
      display:flex;
      align-items:center;
      gap:6px;
      border-radius:999px;
      border:1px solid var(--ring);
      padding:8px 10px;
      font-size:13px;
      cursor:pointer;
      background:#f9fafb;
      transition:background .12s, border-color .12s, transform .12s, box-shadow .12s;
    }
    .pill-check input{margin:0}
    .pill-check.active{
      background:#eef2ff;
      border-color:var(--brand);
      box-shadow:0 0 0 1px rgba(37,99,235,.25);
      transform:translateY(-1px);
    }
    .cart-row{
      display:flex;
      justify-content:space-between;
      font-size:14px;
      margin:2px 0;
    }
    .cart-row.muted{color:var(--muted);font-size:13px}
    .cart-row.total{
      margin-top:8px;
      padding-top:8px;
      border-top:1px dashed var(--ring);
      font-weight:700;
    }
    .msg{font-size:12px;margin-top:4px;color:var(--muted)}
    .msg-error{color:#b91c1c}
    .flex{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .mt-3{margin-top:12px}
    .mt-4{margin-top:16px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1 class="h1">Lazy Day Mobile Oil</h1>
    <p class="sub">You relax — we come to you. Use your VIN to auto-fill vehicle details, upload photos, select services, pick a time, and pay securely.</p>

    <!-- CUSTOMER (NEW) -->
    <section class="card">
      <div class="card-header"><h2 class="card-title">Customer</h2></div>
      <div class="grid grid-2">
        <div><div class="label">First Name</div><input id="firstName" class="input"></div>
        <div><div class="label">Last Name</div><input id="lastName" class="input"></div>
      </div>
      <div class="grid grid-2 mt-3">
        <div><div class="label">Phone</div><input id="phone" class="input"></div>
        <div><div class="label">Email</div><input id="email" class="input"></div>
      </div>
    </section>

    <!-- SERVICE ADDRESS -->
    <section class="card">
      <div class="card-header"><h2 class="card-title">Service Address</h2></div>
      <div class="grid grid-2">
        <div><div class="label">Street</div><input id="svcStreet" class="input"></div>
        <div><div class="label">City</div><input id="svcCity" class="input"></div>
      </div>
      <div class="grid grid-3 mt-3">
        <div><div class="label">State</div><input id="svcState" class="input" value="IN"></div>
        <div><div class="label">ZIP</div><input id="svcZip" class="input"></div>
      </div>
      <div class="mt-3">
        <div class="label">Technician Notes</div>
        <textarea id="svcNotes" class="input" rows="3" placeholder="Gate code, parking, pets, etc."></textarea>
      </div>
    </section>

    <!-- VIN LOOKUP -->
    <section class="card">
      <div class="card-header">
        <h2 class="card-title">VIN Lookup</h2>
        <button class="btn btn-outline" id="vin-demo-btn" type="button">Demo VIN</button>
      </div>
      <div class="grid grid-3">
        <div><div class="label">VIN</div><input id="vin" class="input"></div>
        <div class="flex" style="align-items:flex-end;"><button id="vin-lookup-btn" class="btn">Lookup VIN</button></div>
      </div>
      <div class="grid grid-3 mt-3">
        <div><div class="label">Year</div><input id="year" class="input" readonly></div>
        <div><div class="label">Make</div><input id="make" class="input" readonly></div>
        <div><div class="label">Model</div><input id="model" class="input" readonly></div>
      </div>
      <div class="grid grid-3 mt-3">
        <div><div class="label">Engine</div><input id="engine" class="input" readonly></div>
        <div><div class="label">Oil Capacity (qts)</div><input id="oilCapacity" class="input" readonly></div>
        <div>
          <div class="label">Oil Grade</div>
          <select id="oilGrade" class="input">
            <option value="">Select…</option>
            <option>0W-20</option><option>5W-20</option>
            <option>5W-30</option><option>0W-30</option>
            <option>10W-30</option><option>15W-40</option>
          </select>
        </div>
      </div>
      <div class="msg">VIN lookup helps us estimate oil capacity and confirm the right parts.</div>
      <div id="vin-msg" class="msg msg-error" style="display:none"></div>
    </section>

    <!-- VEHICLE PHOTOS -->
    <section class="card">
      <div class="card-header"><h2 class="card-title">Vehicle Photos (Required)</h2></div>
      <div class="grid grid-4">
        <div><div class="label">Front</div><input id="photoFront" type="file" class="input" accept="image/*"></div>
        <div><div class="label">Driver Side</div><input id="photoDriver" type="file" class="input" accept="image/*"></div>
        <div><div class="label">Passenger Side</div><input id="photoPassenger" type="file" class="input" accept="image/*"></div>
        <div><div class="label">Rear</div><input id="photoRear" type="file" class="input" accept="image/*"></div>
      </div>
      <div class="msg msg-error">All four photos are required before booking.</div>
    </section>

    <!-- SERVICES -->
    <section class="card">
      <div class="card-header"><h2 class="card-title">Services</h2></div>
      <div class="grid grid-2">
        <div>
          <div class="label">Primary Service</div>
          <select id="primaryService" class="input">
            <option value="">Select…</option>
            <option value="oil-basic">Oil Change (includes 5 qts)</option>
            <option value="oil-syn">Full Synthetic Oil Change</option>
            <option value="brakes-front">Front Brakes</option>
            <option value="brakes-rear">Rear Brakes</option>
            <option value="brakes-all">Front & Rear Brakes</option>
          </select>
        </div>
        <div>
          <div class="label">Oil Type</div>
          <select id="oilType" class="input">
            <option value="conv">Conventional</option>
            <option value="syn-blend">Synthetic Blend</option>
            <option value="full-syn">Full Synthetic</option>
          </select>
        </div>
      </div>

      <div class="label mt-3">Brake Parts (optional)</div>
      <div class="grid grid-4">
        <label class="pill-check" data-addon="rotors-front">
          <input type="checkbox"><span class="pill-label-main">Rotors (Front pair)</span>
        </label>
        <label class="pill-check" data-addon="rotors-rear">
          <input type="checkbox"><span class="pill-label-main">Rotors (Rear pair)</span>
        </label>
        <label class="pill-check" data-addon="calipers-front">
          <input type="checkbox"><span class="pill-label-main">Calipers (Front pair)</span>
        </label>
        <label class="pill-check" data-addon="calipers-rear">
          <input type="checkbox"><span class="pill-label-main">Calipers (Rear pair)</span>
        </label>
      </div>
    </section>

    <!-- DATE & TIME -->
    <section class="card">
      <div class="card-header"><h2 class="card-title">Preferred Date & Time</h2></div>
      <div class="grid grid-3">
        <div><div class="label">Date</div><input id="prefDate" type="date" class="input"></div>
        <div><div class="label">Time</div><select id="prefTime" class="input"><option value="">Select a time…</option></select></div>
        <div class="flex" style="align-items:flex-end;"><button id="checkTimesBtn" class="btn btn-outline">Check Availability</button></div>
      </div>
      <div id="time-msg" class="msg"></div>
    </section>

    <!-- CART -->
    <section class="card">
      <div class="card-header"><h2 class="card-title">Your Cart</h2></div>
      <div id="cart-lines" style="min-height:40px;color:#6b7280">No items yet.</div>
      <div class="cart-row muted"><span>Indiana Sales Tax (7%)</span><span id="cart-tax">$0.00</span></div>
      <div class="cart-row total"><span>Total</span><span id="cart-total">$0.00</span></div>
      <div class="mt-4 flex">
        <button id="payBtn" class="btn" disabled>Confirm & Pay</button>
      </div>
      <div id="pay-msg" class="msg msg-error" style="display:none"></div>
    </section>
  </div>

  <!-- ================= JS ================= -->
  <script>
    const CALENDAR_ENDPOINT =
      "https://script.google.com/macros/s/AKfycbzo6QgEqlVlEy6Ht8mRIDHxL2p5TeSkbbfif_VEmRgka80E2_gRokVUNrNMbHZJ9WZW/exec";

    const TAX = 0.07;
    const OVERHEAD_RATE = 0.065;
    const CONVENIENCE_FEE = 0.0;

    const PRICING = {
      primary: {
        "oil-basic": 109.99,
        "oil-syn": 139.99,
        "brakes-front": 289.99,
        "brakes-rear": 289.99,
        "brakes-all": 529.99
      },
      extraQt: {
        conv: 7.99,
        "syn-blend": 9.99,
        "full-syn": 12.99
      },
      addons: {
        "rotors-front": 249.99,
        "rotors-rear": 249.99,
        "calipers-front": 259.99,
        "calipers-rear": 259.99
      }
    };

    const firstNameInput = document.getElementById("firstName");
    const lastNameInput  = document.getElementById("lastName");
    const phoneInput     = document.getElementById("phone");
    const emailInput     = document.getElementById("email");

    const vinInput = document.getElementById("vin");
    const vinBtn = document.getElementById("vin-lookup-btn");
    const vinDemoBtn = document.getElementById("vin-demo-btn");
    const vinMsg = document.getElementById("vin-msg");
    const yearInput = document.getElementById("year");
    const makeInput = document.getElementById("make");
    const modelInput = document.getElementById("model");
    const engineInput = document.getElementById("engine");
    const oilCapacityInput = document.getElementById("oilCapacity");
    const oilGradeSelect = document.getElementById("oilGrade");

    const primaryServiceSelect = document.getElementById("primaryService");
    const oilTypeSelect = document.getElementById("oilType");

    const prefDateInput = document.getElementById("prefDate");
    const prefTimeSelect = document.getElementById("prefTime");
    const checkTimesBtn = document.getElementById("checkTimesBtn");
    const timeMsg = document.getElementById("time-msg");

    const cartLines   = document.getElementById("cart-lines");
    const cartTaxEl   = document.getElementById("cart-tax");
    const cartTotalEl = document.getElementById("cart-total");
    const payBtn      = document.getElementById("payBtn");
    const payMsg      = document.getElementById("pay-msg");

    const svcStreetInput = document.getElementById("svcStreet");
    const svcCityInput   = document.getElementById("svcCity");
    const svcStateInput  = document.getElementById("svcState");
    const svcZipInput    = document.getElementById("svcZip");
    const svcNotesInput  = document.getElementById("svcNotes");

    const photoFrontInput     = document.getElementById("photoFront");
    const photoDriverInput    = document.getElementById("photoDriver");
    const photoPassengerInput = document.getElementById("photoPassenger");
    const photoRearInput      = document.getElementById("photoRear");

    const addonPills = Array.from(document.querySelectorAll("[data-addon]"));

    function fmt(n){ return "$"+n.toFixed(2); }
    function getOilCapacity(){
      const v = parseFloat(oilCapacityInput.value);
      return isNaN(v)||v<=0 ? 5 : v;
    }

    let latestQuote = {items:[],subtotal:0,overhead:0,tax:0,total:0};

    function recalcPricing(){
      const svc = primaryServiceSelect.value;
      if(!svc){
        cartLines.textContent = "No items yet.";
        cartTaxEl.textContent = fmt(0);
        cartTotalEl.textContent = fmt(0);
        payBtn.disabled = true;
        return;
      }
      const oilTypeKey = oilTypeSelect.value || "conv";
      const qts = getOilCapacity();
      const items = [];
      let subtotal = 0;

      const base = PRICING.primary[svc] || 0;
      items.push({
        label: primaryServiceSelect.options[primaryServiceSelect.selectedIndex].text,
        amount: base
      });
      subtotal += base;

      if(svc.startsWith("oil")){
        const extra = Math.max(0, qts - 5);
        if(extra > 0){
          const perQt = PRICING.extraQt[oilTypeKey] || PRICING.extraQt.conv;
          const extraPrice = extra * perQt;
          items.push({label:`Extra oil (${extra.toFixed(1)} qts)`, amount:extraPrice});
          subtotal += extraPrice;
        }
      }

      addonPills.forEach(p=>{
        const key = p.dataset.addon;
        const cb  = p.querySelector("input");
        p.classList.toggle("active", cb.checked);
        if(!cb.checked) return;
        const price = PRICING.addons[key] || 0;
        items.push({label:key, amount:price});
        subtotal += price;
      });

      const overhead = subtotal * OVERHEAD_RATE;
      const taxBase  = subtotal + overhead + CONVENIENCE_FEE;
      const tax      = taxBase * TAX;
      const total    = taxBase + tax;

      latestQuote = {items, subtotal, overhead, tax, total};
      renderCart();
    }

    function renderCart(){
      if(!latestQuote.items.length){
        cartLines.textContent = "No items yet.";
        return;
      }
      cartLines.innerHTML = "";
      latestQuote.items.forEach(it=>{
        const row = document.createElement("div");
        row.className = "cart-row";
        row.innerHTML = `<span>${it.label}</span><span>${fmt(it.amount)}</span>`;
        cartLines.appendChild(row);
      });
      cartTaxEl.textContent   = fmt(latestQuote.tax);
      cartTotalEl.textContent = fmt(latestQuote.total);
      payBtn.disabled = false;
    }

    async function handleVinLookup(){
      vinMsg.style.display = "none";
      vinMsg.textContent = "";
      const vin = vinInput.value.trim();
      if(!vin){
        vinMsg.textContent = "Enter a VIN first.";
        vinMsg.style.display = "block";
        return;
      }
      vinBtn.disabled = true;
      vinBtn.textContent = "Looking up…";
      try{
        const url = `${CALENDAR_ENDPOINT}?path=vin&vin=${encodeURIComponent(vin)}`;
        const res = await fetch(url);
        const data = await res.json();
        if(!data.ok) throw new Error(data.error || "VIN lookup failed");
        yearInput.value        = data.year   || "";
        makeInput.value        = data.make   || "";
        modelInput.value       = data.model  || "";
        engineInput.value      = data.engine || "";
        oilCapacityInput.value = data.oilQts != null ? data.oilQts : "";
        recalcPricing();
      }catch(err){
        console.error(err);
        vinMsg.textContent = err.message;
        vinMsg.style.display = "block";
      }finally{
        vinBtn.disabled = false;
        vinBtn.textContent = "Lookup VIN";
      }
    }

    vinDemoBtn.addEventListener("click", ()=>{ vinInput.value = "1GT49VEY4RF249205"; });
    vinBtn.addEventListener("click", handleVinLookup);
    vinInput.addEventListener("keydown", e=>{
      if(e.key === "Enter"){
        e.preventDefault();
        handleVinLookup();
      }
    });

    async function handleCheckTimes(){
      timeMsg.textContent = "";
      const date = prefDateInput.value;
      const svc  = primaryServiceSelect.value;

      if(!date){ timeMsg.textContent="Choose a date first."; return; }
      if(!svc){ timeMsg.textContent="Choose a primary service first."; return; }

      let appointmentTypeID = "85364590"; // Oil change default
      if(svc==="brakes-front") appointmentTypeID = "85364671";
      if(svc==="brakes-rear")  appointmentTypeID = "85364740";
      if(svc==="brakes-all")   appointmentTypeID = "85364836";

      checkTimesBtn.disabled = true;
      checkTimesBtn.textContent = "Checking…";

      try{
        const url = `${CALENDAR_ENDPOINT}?path=times&date=${encodeURIComponent(date)}&appointmentTypeID=${encodeURIComponent(appointmentTypeID)}`;
        const res = await fetch(url);
        const data = await res.json();
        if(!data.ok) throw new Error(data.error || "Could not load times");

        const times = data.times || [];
        prefTimeSelect.innerHTML = `<option value="">Select a time…</option>`;
        times.forEach(t=>{
          const label = t.includes("T") ? t.split("T")[1].slice(0,5) : t; // basic label (HH:MM)
          const opt = document.createElement("option");
          opt.value = t;      // full Acuity value (keeps functionality)
          opt.textContent = label; // only time portion
          prefTimeSelect.appendChild(opt);
        });

        timeMsg.textContent = times.length
          ? "Times loaded from our live schedule."
          : "No open slots for that date. Try another day.";
      }catch(err){
        console.error(err);
        timeMsg.textContent = err.message;
      }finally{
        checkTimesBtn.disabled = false;
        checkTimesBtn.textContent = "Check Availability";
      }
    }

    checkTimesBtn.addEventListener("click", handleCheckTimes);

    // simple payment stub – backend does real Stripe work
    async function handlePay(){
      payMsg.style.display = "none";
      payMsg.textContent = "";
      if(!latestQuote.items.length){
        payMsg.textContent = "Add a service first.";
        payMsg.style.display = "block";
        return;
      }
      if(!prefDateInput.value || !prefTimeSelect.value){
        payMsg.textContent = "Pick a date and time before paying.";
        payMsg.style.display = "block";
        return;
      }
      payBtn.disabled = true;
      payBtn.textContent = "Sending…";
      try{
        const payload = {
          path:"create-payment-intent",
          amount:Math.round(latestQuote.total*100),
          currency:"usd",
          description:"Lazy Day Mobile Oil Service",
          meta:{
            firstName:firstNameInput.value,
            lastName:lastNameInput.value,
            phone:phoneInput.value,
            email:emailInput.value,
            serviceStreet:svcStreetInput.value,
            serviceCity:svcCityInput.value,
            serviceState:svcStateInput.value,
            serviceZip:svcZipInput.value,
            serviceNotes:svcNotesInput.value,
            vin:vinInput.value.trim(),
            year:yearInput.value,
            make:makeInput.value,
            model:modelInput.value,
            engine:engineInput.value,
            oilCapacity:oilCapacityInput.value,
            oilGrade:oilGradeSelect.value,
            primaryService:primaryServiceSelect.value,
            oilType:oilTypeSelect.value,
            addons:addonPills.filter(p=>p.querySelector("input").checked).map(p=>p.dataset.addon),
            date:prefDateInput.value,
            time:prefTimeSelect.value,
            quote:latestQuote
          }
        };
 // send as a simple form POST so Apps Script accepts it without CORS issues
const res = await fetch(CALENDAR_ENDPOINT, {
  method: "POST",
  body: "data=" + encodeURIComponent(JSON.stringify(payload))
});
const data = await res.json();

        if(!data.ok) throw new Error(data.error || "Payment failed");
        alert("Order received! We will confirm your appointment shortly.");
      }catch(err){
        console.error(err);
        payMsg.textContent = err.message;
        payMsg.style.display = "block";
      }finally{
        payBtn.disabled=false;
        payBtn.textContent="Confirm & Pay";
      }
    }

    payBtn.addEventListener("click", handlePay);

    primaryServiceSelect.addEventListener("change", recalcPricing);
    oilTypeSelect.addEventListener("change", recalcPricing);
    addonPills.forEach(p=>{
      p.querySelector("input").addEventListener("change", recalcPricing);
    });

    recalcPricing();
  </script>
</body>
</html>

