<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Lazy Day Mobile Oil – Book Service</title>
  <style>
    :root{
      --ink:#0f172a;
      --brand:#0E2A47;
      --accent:#C7382E;
      --bg:#F7F1E6;
      --ring:#e5e7eb;
      --muted:#6b7280;
      --radius-lg:18px;
    }
    *{box-sizing:border-box}
    html{scroll-behavior:smooth}
    body{
      margin:0;
      background:var(--bg);
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      color:var(--ink);
    }
    .wrap{
      max-width:1100px;
      margin:0 auto;
      padding:20px 16px 60px;
    }
    .h1{margin:0 0 4px;font-size:30px;font-weight:900;color:var(--brand)}
    .sub{margin:0 0 18px;color:var(--muted);font-size:14px}
    .grid{display:grid;gap:12px}
    @media(min-width:768px){
      .grid-2{grid-template-columns:repeat(2,1fr)}
      .grid-3{grid-template-columns:repeat(3,1fr)}
      .grid-4{grid-template-columns:repeat(4,1fr)}
    }
    .card{
      background:#fff;
      border-radius:var(--radius-lg);
      border:1px solid var(--ring);
      padding:16px;
      margin-bottom:16px;
      box-shadow:0 18px 30px rgba(15,23,42,.06)
    }
    .card-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:10px;
    }
    .card-title{font-size:18px;font-weight:700;color:var(--brand);margin:0}
    .label{
      font-size:12px;font-weight:600;text-transform:uppercase;color:var(--muted);margin-bottom:4px
    }
    .input,select,textarea{
      width:100%;padding:8px 10px;border-radius:10px;border:1px solid var(--ring);
      background:#f9fafb;font-size:14px;outline:none;
    }
    .btn{
      border-radius:999px;padding:9px 16px;border:0;font-size:14px;font-weight:600;
      background:var(--brand);color:white;cursor:pointer;
    }
  </style>
</head>
<body>
<div class="wrap">

<h1 class="h1">Lazy Day Mobile Oil</h1>
<p class="sub">Use your VIN to auto-fill vehicle details, pick services, then select a time and book.</p>

<!-- SERVICE ADDRESS -->
<section class="card">
  <div class="card-header"><h2 class="card-title">Service Address</h2></div>
  <div class="grid grid-2">
    <div><div class="label">Street</div><input id="svcStreet" class="input"></div>
    <div><div class="label">City</div><input id="svcCity" class="input"></div>
  </div>
  <div class="grid grid-3 mt-3">
    <div><div class="label">State</div><input id="svcState" class="input" value="IN"></div>
    <div><div class="label">ZIP</div><input id="svcZip" class="input"></div>
  </div>
  <div class="mt-3">
    <div class="label">Technician Notes</div>
    <textarea id="svcNotes" class="input" rows="3"></textarea>
  </div>
</section>

<!-- VIN LOOKUP -->
<section class="card">
  <div class="card-header">
    <h2 class="card-title">VIN Lookup</h2>
    <button id="vin-demo-btn" class="btn btn-outline">Demo VIN</button>
  </div>
  <div class="grid grid-3">
    <div><div class="label">VIN</div><input id="vin" class="input"></div>
    <div><button id="vin-lookup-btn" class="btn" style="margin-top:22px;">Lookup VIN</button></div>
  </div>

  <div class="grid grid-3 mt-3">
    <div><div class="label">Year</div><input id="year" class="input" readonly></div>
    <div><div class="label">Make</div><input id="make" class="input" readonly></div>
    <div><div class="label">Model</div><input id="model" class="input" readonly></div>
  </div>
  <div class="grid grid-3 mt-3">
    <div><div class="label">Engine</div><input id="engine" class="input" readonly></div>
    <div><div class="label">Oil Capacity</div><input id="oilCapacity" class="input" readonly></div>
    <div>
      <div class="label">Oil Grade</div>
      <select id="oilGrade" class="input">
        <option value="">Select…</option>
        <option>0W-20</option><option>5W-20</option>
        <option>5W-30</option><option>0W-30</option>
        <option>10W-30</option><option>15W-40</option>
      </select>
    </div>
  </div>
  <div id="vin-msg" class="msg msg-error" style="color:#b91c1c;margin-top:6px;display:none"></div>
</section>

<!-- PHOTOS -->
<section class="card">
  <div class="card-header"><h2 class="card-title">Vehicle Photos (Required)</h2></div>
  <div class="grid grid-4">
    <div><div class="label">Front</div><input id="photoFront" type="file" class="input"></div>
    <div><div class="label">Driver</div><input id="photoDriver" type="file" class="input"></div>
    <div><div class="label">Passenger</div><input id="photoPassenger" type="file" class="input"></div>
    <div><div class="label">Rear</div><input id="photoRear" type="file" class="input"></div>
  </div>
</section>

<!-- SERVICES -->
<section class="card">
  <div class="card-header"><h2 class="card-title">Services</h2></div>
  <div class="grid grid-2">
    <div>
      <div class="label">Primary Service</div>
      <select id="primaryService" class="input">
        <option value="">Select…</option>
        <option value="oil-basic">Oil Change (includes 5 qts)</option>
        <option value="oil-syn">Full Synthetic Oil Change</option>
        <option value="brakes-front">Front Brake Pads & Labor</option>
        <option value="brakes-rear">Rear Brake Pads & Labor</option>
        <option value="brakes-all">Front & Rear Brake Pads</option>
      </select>
    </div>
    <div>
      <div class="label">Oil Type</div>
      <select id="oilType" class="input">
        <option value="conv">Conventional</option>
        <option value="syn-blend">Synthetic Blend</option>
        <option value="full-syn">Full Synthetic</option>
      </select>
    </div>
  </div>

  <div class="label mt-3">Brake Parts (optional)</div>
  <div class="grid grid-4">
    <label class="pill-check" data-addon="rotors-front">
      <input type="checkbox"> Rotors (Front pair)
    </label>
    <label class="pill-check" data-addon="rotors-rear">
      <input type="checkbox"> Rotors (Rear pair)
    </label>
    <label class="pill-check" data-addon="calipers-front">
      <input type="checkbox"> Calipers (Front pair)
    </label>
    <label class="pill-check" data-addon="calipers-rear">
      <input type="checkbox"> Calipers (Rear pair)
    </label>
  </div>
</section>

<!-- DATE/TIME -->
<section class="card">
  <div class="card-header"><h2 class="card-title">Preferred Date & Time</h2></div>
  <div class="grid grid-3">
    <div><div class="label">Date</div><input id="prefDate" type="date" class="input"></div>
    <div><div class="label">Time</div><select id="prefTime" class="input"><option value="">Select…</option></select></div>
    <div style="display:flex;align-items:flex-end;">
      <button id="checkTimesBtn" class="btn btn-outline">Check Availability</button>
    </div>
  </div>
  <div id="time-msg" class="msg" style="margin-top:6px;"></div>
</section>

<!-- CART -->
<section class="card">
  <div class="card-header"><h2 class="card-title">Your Cart</h2></div>
  <div id="cart-lines" style="min-height:30px;color:#6b7280;"></div>
  <div class="cart-row muted"><span>Indiana Sales Tax (7%)</span><span id="cart-tax">$0.00</span></div>
  <div class="cart-row total"><span>Total</span><span id="cart-total">$0.00</span></div>
  <div class="mt-4 flex">
    <button id="payBtn" class="btn" disabled>Confirm & Pay</button>
  </div>
  <div id="pay-msg" class="msg msg-error" style="display:none"></div>
</section>

</div>

<!-- ================= JS STARTS HERE ================= -->

<script>
// LIVE BACKEND ENDPOINT
const CALENDAR_ENDPOINT="https://script.google.com/macros/s/AKfycbzo6QgEqlVlEy6Ht8mRIDHxL2p5TeSkbbfif_VEmRgka80E2_gRokVUNrNMbHZJ9WZW/exec";

const TAX=0.07, OVERHEAD_RATE=0.065, FEE=0.0;

const PRICING={
  primary:{
    "oil-basic":109.99,
    "oil-syn":139.99,
    "brakes-front":289.99,
    "brakes-rear":289.99,
    "brakes-all":529.99,
  },
  extraQt:{conv:7.99,"syn-blend":9.99,"full-syn":12.99},
  addons:{
    "rotors-front":249.99,
    "rotors-rear":249.99,
    "calipers-front":259.99,
    "calipers-rear":259.99
  }
};

// DOM refs
const vinInput=document.getElementById("vin");
const vinBtn=document.getElementById("vin-lookup-btn");
const vinDemoBtn=document.getElementById("vin-demo-btn");
const vinMsg=document.getElementById("vin-msg");
const yearInput=document.getElementById("year");
const makeInput=document.getElementById("make");
const modelInput=document.getElementById("model");
const engineInput=document.getElementById("engine");
const oilCapacityInput=document.getElementById("oilCapacity");
const oilGradeSelect=document.getElementById("oilGrade");
const primaryServiceSelect=document.getElementById("primaryService");
const oilTypeSelect=document.getElementById("oilType");
const prefDateInput=document.getElementById("prefDate");
const prefTimeSelect=document.getElementById("prefTime");
const checkTimesBtn=document.getElementById("checkTimesBtn");
const timeMsg=document.getElementById("time-msg");
const cartLines=document.getElementById("cart-lines");
const cartTaxEl=document.getElementById("cart-tax");
const cartTotalEl=document.getElementById("cart-total");
const payBtn=document.getElementById("payBtn");
const payMsg=document.getElementById("pay-msg");
const svcNotesInput=document.getElementById("svcNotes");
const svcStreetInput=document.getElementById("svcStreet");
const svcCityInput=document.getElementById("svcCity");
const svcStateInput=document.getElementById("svcState");
const svcZipInput=document.getElementById("svcZip");
const addonPills=[...document.querySelectorAll("[data-addon]")];

function fmt(n){return"$"+n.toFixed(2)}
function getOilQts(){const v=parseFloat(oilCapacityInput.value);return isNaN(v)?5:v}

let latestQuote={items:[],subtotal:0,overhead:0,tax:0,total:0};

function recalc(){
  const svc=primaryServiceSelect.value;
  if(!svc){
    cartLines.textContent="No items yet.";
    cartTaxEl.textContent=fmt(0);
    cartTotalEl.textContent=fmt(0);
    payBtn.disabled=true;
    return;
  }

  const items=[];
  let subtotal=0;
  const base=PRICING.primary[svc]||0;
  items.push({label:primaryServiceSelect.selectedOptions[0].text,amount:base});
  subtotal+=base;

  if(svc.startsWith("oil")){
    const q=getOilQts();
    const extra=Math.max(0,q-5);
    if(extra>0){
      const cost=extra*(PRICING.extraQt[oilTypeSelect.value]||PRICING.extraQt.conv);
      items.push({label:`Extra oil (${extra.toFixed(1)} qts)`,amount:cost});
      subtotal+=cost;
    }
  }

  addonPills.forEach(p=>{
    const key=p.dataset.addon;
    const cb=p.querySelector("input");
    p.classList.toggle("active",cb.checked);
    if(!cb.checked)return;
    items.push({label:key,amount:PRICING.addons[key]});
    subtotal+=PRICING.addons[key];
  });

  const oh=subtotal*OVERHEAD_RATE;
  const tax=(subtotal+oh+FEE)*TAX;
  const total=subtotal+oh+FEE+tax;

  latestQuote={items,subtotal,overhead:oh,tax,total};
  renderCart();
}

function renderCart(){
  if(!latestQuote.items.length){
    cartLines.textContent="No items yet.";
    return;
  }
  cartLines.innerHTML="";
  latestQuote.items.forEach(i=>{
    const row=document.createElement("div");
    row.className="cart-row";
    row.innerHTML=`<span>${i.label}</span><span>${fmt(i.amount)}</span>`;
    cartLines.appendChild(row);
  });
  cartTaxEl.textContent=fmt(latestQuote.tax);
  cartTotalEl.textContent=fmt(latestQuote.total);
  payBtn.disabled=false;
}

async function handleVin(){
  vinMsg.style.display="none";
  if(!vinInput.value.trim()){
    vinMsg.textContent="Enter a VIN first.";
    vinMsg.style.display="block";
    return;
  }
  vinBtn.disabled=true;
  try{
    const url=`${CALENDAR_ENDPOINT}?path=vin&vin=${encodeURIComponent(vinInput.value)}`;
    const res=await fetch(url);
    const data=await res.json();
    if(!data.ok) throw new Error(data.error||"VIN failed");
    yearInput.value=data.year||"";
    makeInput.value=data.make||"";
    modelInput.value=data.model||"";
    engineInput.value=data.engine||"";
    oilCapacityInput.value=data.oilQts||"";
    recalc();
  }catch(err){
    vinMsg.textContent=err.message;
    vinMsg.style.display="block";
  }finally{
    vinBtn.disabled=false;
  }
}

vinDemoBtn.onclick=()=>vinInput.value="1GT49VEY4RF249205";
vinBtn.onclick=handleVin;
vinInput.onkeydown=e=>{if(e.key==="Enter"){e.preventDefault();handleVin()}};

async function handleTimes(){
  timeMsg.textContent="";
  if(!prefDateInput.value){timeMsg.textContent="Choose a date.";return}
  if(!primaryServiceSelect.value){timeMsg.textContent="Choose a service.";return}

  const svc=primaryServiceSelect.value;
  let id="85364590";
  if(svc==="brakes-front") id="85364671";
  if(svc==="brakes-rear")  id="85364740";
  if(svc==="brakes-all")   id="85364836";

  checkTimesBtn.disabled=true;
  try{
    const url=`${CALENDAR_ENDPOINT}?path=times&date=${prefDateInput.value}&appointmentTypeID=${id}`;
    const r=await fetch(url);
    const data=await r.json();
    if(!data.ok) throw new Error(data.error);
    prefTime
